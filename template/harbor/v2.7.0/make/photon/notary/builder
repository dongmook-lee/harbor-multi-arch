#!/bin/bash

set +e

if [ -z $2 ]; then
  error "Please set the notary and migrate version"
  exit 1
fi

echo "Building notary and golang-migrate from source, notary version: $1, golang-migrate version: $2"
set -e

# the temp folder to store binary file...
sudo mkdir -p binary
# don't remove all like migrate-patch-* which generated by `make compile_notary_migrate_patch`
sudo rm -rf binary/notary-* || true;
sudo rm -rf binary/migrate-linux-* || true;
sudo rm -rf binary/migrations || true;

echo "dirname == `dirname $0`"
cd `dirname $0`
echo "path == `pwd`"
NOTARY_VERSION=$1
MIGRATE_VERSION=$2


echo "build binary notary binaries..."
sudo docker build --build-arg TARGETARCHS="${TARGETARCHS}" --build-arg NOTARY_VERSION=${NOTARY_VERSION} --build-arg MIGRATE_VERSION=${MIGRATE_VERSION} -f ./binary.Dockerfile -t notary-binary .

echo 'copy the binary files to local...'
ID=$(sudo docker create notary-binary)

for targetarch in ${TARGETARCHS}; do
  sudo docker cp $ID:/go/bin/notary-server-linux-${targetarch} binary/notary-server-linux-${targetarch}
  sudo docker cp $ID:/go/bin/notary-signer-linux-${targetarch} binary/notary-signer-linux-${targetarch}
  sudo docker cp $ID:/go/bin/migrate-linux-${targetarch} binary/migrate-linux-${targetarch}
done
echo "`ls -al ./`"
echo "==========="
echo "ls -al ./notary"

sudo docker cp $ID:/migrations binary/migrations
sudo sed -i 's/waiting for $DB_URL/waiting for database/g' binary/migrations/migrate.sh;

sudo docker rm -f $ID
sudo docker rmi -f notary-binary

